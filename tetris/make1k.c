#include <stdio.h>
#include <stdlib.h>
#include <string.h>

  int size, i, j;
  char *pos, buffer[1024], mem[44], silence[512];
  const unsigned short c4689= 4689;
  FILE *fi, *fo;

  unsigned char data0[]=
   {0x5a, 0x58, 0x54, 0x61, 0x70, 0x65, 0x21, 0x1a, 0x01, 0x14, 0x19, 0x9a,
                                              0x00, 0x00, 0x00, 0x64, 0x00};
  unsigned char data1[]=
   {0x10, 0x02, 0x00, 0x00, 0x12, 0x02, 0x03};
  unsigned char data2[]=
   {0x12, 0x02, 0x08, 0x02, 0x12, 0x02, 0x08, 0x02, 0x12, 0x02, 0x08, 0x02,
    0x12, 0x02, 0x08, 0x02, 0x12, 0x02, 0x08, 0x02, 0x12, 0x02, 0x08, 0x02,
                0x12, 0x02, 0x08, 0x02, 0x12, 0x02, 0x08, 0x02, 0x12, 0x02};
  unsigned char data3[]=
   {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
  unsigned char data4[]=
   {0x51, 0x12, 0xa0, 0x31, 0xfe, 0x43, 0x21, 0x40, 0x40, 0x1e, 0x00, 0x43,
    0x18, 0x0d, 0x49, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xed, 0xb0, 0x18, 0x06, 0x00, 0x00, 0x00, 0x00, 0x2e,
    0x40, 0xc3, 0x40, 0x03, 0x00, 0x01, 0x00, 0x00, 0xf9, 0xd4, 0x25, 0x25,
                0x7e, 0x8f, 0x00, 0x12, 0x76, 0x76, 0x0b, 0x0b, 0x76, 0x76};
  unsigned char data5[]=
   {0x00, 0x19, 0x51, 0x04, 0x00, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00,
                      0x00, 0x00, 0xc8, 0x1f, 0x00, 0x00, 0x12, 0x02, 0x03};
  unsigned char wav0[]= // 108
   {0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
    0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40,
    0x40, 0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40,
    0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0x40, 0x40,
    0x40, 0x40, 0x40, 0x40, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80};
  unsigned char wav1[]= // 173
   {0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
    0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40,
    0x40, 0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40,
    0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0x40, 0x40,
    0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0x40,
    0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40,
    0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
    0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
    0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0xc0,
    0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80};

void datawrite( char * input, int length ){
  for ( i= 0; i<length; i++ )
    for ( j= 0; j<8; j++ )
      if( input[i]<<j&0x80 )
        fwrite( wav1, 1, 173, fo );
      else
        fwrite( wav0, 1, 108, fo );
}

int main(int argc, char* argv[]){
  if( argc==1 )
    printf("\n"
    "make1k. Generates z81, tzx and wav from 1k binary, Antonio Villena, 5 Aug 2014\n\n"
    "  make1k <input_file>\n\n"
    "  <input_file>   Origin file, must be 1024 bytes long\n"),
    exit(0);
  if( argc!=2 )
    printf("\nInvalid number of parameters\n"),
    exit(-1);
  fi= fopen(argv[1], "rb");
  if( !fi )
    printf("\nInput file not found: %s\n", argv[1]),
    exit(-1);
  pos= strchr(argv[1], '.');
  if( !pos )
    printf("\nInput filename must have .bin extension\n"),
    exit(-1);
  fseek(fi, 0, SEEK_END);
  size= ftell(fi);
  rewind(fi);
  if( size!=1024 )
    printf("\nInput file incorrect length %s, must be 1024\n", size),
    exit(-1);
  fread(buffer, 1, 1024, fi);
  fclose(fi);

// generates the Z81
  strcpy(pos, ".z81");
  fo= fopen(argv[1], "wb+");
  fprintf(fo, "[CPU]\n"
              "PC %04X    SP  4400\n"
              "HL 403B    HL_ 10D2\n"
              "DE FFFF    DE_ 002B\n"
              "BC 0080    BC_ 8102\n"
              "AF 0185    AF_ CA89\n"
              "IX 0281    IY  4000\n"
              "IR 1E90\n"
              "IM 01      IF1 00\n"
              "HT 00      IF2 00\n\n"
              "[ZX81]\n"
              "NMI 01     HSYNC 01\n"
              "ROW 000\n\n"
              "[MEMORY]\n"
              "MEMRANGE 4000 43FF\n%02X", buffer[0x3fe] | buffer[0x3ff]<<8, buffer[0]);
  for ( i= 1; i<0x400; i++ )
    fprintf(fo, " %02X", (unsigned char) buffer[i]);
  fprintf(fo, "\n\n[EOF]\n", (unsigned char) buffer[i]);
  fclose(fo);
  printf("File %s generated suceffuly\n", argv[1]);

// generates the TZX
  strcpy(pos, ".tzx");
  fo= fopen(argv[1], "wb+");
  fwrite(data0, 1, 17, fo);
  fwrite(data3, 1, 6, fo);
  fwrite(data1, 1, 7, fo);
  fwrite(data2, 1, 14, fo);
  fwrite(&c4689, 2, 1, fo);
  fwrite(data3, 1, 20, fo);
  i= 3;
  fwrite(&i, 1, 1, fo);
  fwrite(data2, 1, 34, fo);
  fwrite(data4, 1, 58, fo);
  fwrite(buffer, 1, 9, fo);
  fwrite(data5, 1, 21, fo);
  fwrite(data2, 1, 14, fo);
  fwrite(&c4689, 2, 1, fo);
  fwrite(data3, 1, 20, fo);
  fwrite(&i, 1, 1, fo);
  fwrite(data2, 1, 34, fo);
  fwrite(&c4689, 2, 1, fo);
  i= 0xa0;
  fwrite(&i, 1, 1, fo);
  fwrite(buffer+9, 1, 1015, fo);
  i= 0x80;
  fwrite(&i, 1, 1, fo);
  fclose(fo);
  printf("File %s generated suceffuly\n", argv[1]);

// generates the WAV
  strcpy(pos, ".wav");
  fo= fopen(argv[1], "wb+");
  memset(mem, 0, 44);
  memset(silence, 0x80, 0x200);
  *(int*)mem= 0x46464952;
  *(int*)(mem+8)= 0x45564157;
  *(int*)(mem+12)= 0x20746d66;
  *(char*)(mem+16)= 0x10;
  *(char*)(mem+20)= *(char*)(mem+22)= *(char*)(mem+32)= 1;
  *(short*)(mem+24)= *(int*)(mem+28)= 44100;
  *(char*)(mem+34)= 8;
  *(int*)(mem+36)= 0x61746164;
  fwrite(mem, 1, 44, fo);
  fwrite(silence, 1, 0x200, fo);
  datawrite((char *) data4+2, 56);
  datawrite(buffer, 9);
  datawrite((char *) data3, 1);
  fwrite(silence, 1, 0x200, fo);
  datawrite((char *) data4+2, 1);
  datawrite(buffer+9, 1015);
  datawrite((char *) wav0+52, 1);
  fwrite(silence, 1, 0x200, fo);
  i= ftell(fo)-8,
  fseek(fo, 4, SEEK_SET),
  fwrite(&i, 4, 1, fo),
  i-= 36,
  fseek(fo, 40, SEEK_SET),
  fwrite(&i, 4, 1, fo);
  fclose(fo);
  printf("File %s generated suceffuly\n", argv[1]);
}
